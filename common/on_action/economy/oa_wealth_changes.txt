yearly_country_pulse = {
	on_actions = {

		# Education - run for each country
		yearly_edu_update_pulse
		delay = { days = 1 }
		yearly_edu_update_pulse_from_trade

		# Trade - run only once for all countries
		quarterly_trade_pulse
		quarterly_flavour_pulse
		delay = { days = 91 }
		quarterly_flavour_pulse
		quarterly_trade_pulse
		delay = { days = 182 }
		quarterly_flavour_pulse
		quarterly_trade_pulse
		delay = { days = 273 }
		quarterly_flavour_pulse
		quarterly_trade_pulse

	}
}

monthly_country_pulse = {
	on_actions = {
		monthly_currency_pulse
		monthly_administration_pulse
		monthly_ai_war_pulse
		monthly_setup_new_countries # TODO: Make this daily by firing it 31 times with a delay of 1 day each time, but check performance
	}
}

monthly_setup_new_countries = {
	# on_action to ensure that newly spawned countries have all the attributes they need to function within the imp19c economy
	effect = {
		# TODO:
		# Techs
		# Pop wealth
		# Tradezones?
		if = {
			limit = {
				NOT = {
					has_variable = country_setup_done
				}
			}

			FUNC_setup_new_country = yes

			set_variable = country_setup_done
		}
	}
}

monthly_ai_war_pulse = {
	effect = {
		AI_check_country_peace_deals = yes
	}
}

quarterly_flavour_pulse = {
	on_actions = {
		delay = { days = { 1 91 } }
		flavor_events_pulse
	}
}

flavor_events_pulse = {
	random_events = {
		1 = flavor_eve.1
		1 = flavor_eve.2
		1 = flavor_eve.3
		1 = flavor_eve.4
		1 = flavor_eve.5
		1 = flavor_eve.6
		1 = flavor_eve.7
		1 = flavor_eve.8
		1 = flavor_eve.9
		1 = flavor_eve.10
		1 = flavor_eve.11
		1 = flavor_eve.12
		1 = flavor_eve.13
		1 = flavor_eve.14
		1 = flavor_eve.15
		1 = flavor_eve.16
		1 = flavor_eve.17
		1 = flavor_eve.18
		1 = flavor_eve.19
		1 = flavor_eve.20
	}
}

yearly_edu_update_pulse = {
	effect = {
		EDU_update_effect = yes
	}
}
yearly_edu_update_pulse_from_trade = {
	effect = {
		EDU_set_education_available_from_trade = { tier = t2 }
	}
}

monthly_currency_pulse = {
	effect = {
		if = {
			limit = {
				has_variable = official_currency
				OR = {
					CURRENCY_amt_circulated_balance > 0.5
					CURRENCY_amt_circulated_balance <= -0.5
				}
			}
			CURRENCY_mint_currency = yes
		}
	}
}

monthly_administration_pulse = {
	effect = {
		# TODO: This needs to be much more efficient - ATM, it is causing unacceptable monthly slowdowns
		#ADMIN_set_loyalty_impact_all_states = yes
	}
}

quarterly_trade_pulse = {
	effect = {

		if = {
			limit = {
				NOT = { has_global_variable = done_quarterly_trade }
			}
			remove_global_variable = trade_ranks_sorted # Used by event piechart_update.2
			# Commence Production
			every_country = {
				every_governorships = {
					limit = {
						NOT = {
							has_variable = internal_trade_scope
						}
					}
					CURRENCY_governorship_send_to_reserves = yes
					TRADE_set_internal_trade_scope = yes
					TRADE_update_governorship_TZs = yes # In case new governorships are formed. TODO: slot this into the territory ownership changed effect once that is made
					
				}
				every_governorships = {
					TRADE_governorship_get_pops_this_quarter = yes
					GOODS_governorship_produce_all = yes
					COTTAGEIND_produce_all = yes
				}
				CURRENCY_apply_inflation_wealth_malus_country = yes
			}
			WEALTH_generate_new_all_countries = yes
			WEALTH_pay_wages_all_countries = yes
			# Cache currency power and currency power trade bonuses before trading
			every_province = {
				limit = {
					has_variable = currency_name
				}
				CURRENCY_cache_power = yes
			}
			every_province = {
				limit = {
					has_variable = currency_name
				}
				CURRENCY_cache_power_trade_bonus = yes
			}
			every_country = {
				INCOME_collect_all_taxes_country = yes
				INCOME_update_treasury_country = yes
				WEALTH_cache_national_wealth = yes
				MILITARY_update_supplies = yes
				INCOME_calculate_and_distribute_military_procurement_wealth_owed = yes
			}
			DIPLOMACY_update_global_power_status = yes
			AI_update_all_diplomatic_plays = yes

			set_global_variable = {
				name = done_quarterly_trade
				days = 1
			}
		}

	}
	events = {
		# piechart_update.1 # Update shipping values
		debug_demand.1
		debug_demand.2
		# trade.2 # Defunct
		# debug_demand.3 # Produce manufactured goods
	}

	on_actions = {
		# Trigger the trade for each category one by one within this quarter
		quarterly_deficit_check
		quarterly_reset_trade_transaction_totals
		quarterly_global_trade_food
		delay = { days = 9 }
		quarterly_global_trade_luxury
		delay = { days = 18 }
		quarterly_global_trade_luxury_2
		delay = { days = 27 }
		quarterly_global_trade_3
		delay = { days = 36 }
		quarterly_global_trade_4
		delay = { days = 45 }
		quarterly_global_trade_5
		delay = { days = 54 }
		quarterly_global_trade_6
		delay = { days = 61 }
		quarterly_apply_trade_changes_and_consume
	}
}

quarterly_deficit_check = {
	effect = {
		if = {
			limit = {
				OR = {
					is_ai = yes
					has_variable = auto_fund_deficit
				}
			}
			INCOME_mitigate_deficit = yes
		}
	}
}

quarterly_reset_trade_transaction_totals = {
	effect = {
		if = {
			limit = {
				NOT = { has_global_variable = trade_transaction_totals_reset }
			}
			every_trade_center = {
		    	set_variable = {
		    		name = TZ_shipping
		    		value = 0
		    	}
		    	set_variable = {
		    		name = TZ_this_quarter_transport_pool
		    		value = 0
		    	}
		    }
		    GT_split_setup_global_shipping_costs_pool = yes
			every_country = {
				every_governorships = {
					WEALTH_cache_shipping_trade_values = yes
					DEMAND_cache_and_update_elasticity_impact = yes
					GT_reset_trade_transaction_totals = yes
				}
			}
			SHIPPING_update_TZ_overview_piecharts = yes
			GT_split_update_governorship_vars = yes
			GT_split_cache_TZ_penetration_values = yes
		}
		set_global_variable = {
			name = trade_transaction_totals_reset
			days = 1
		}
	}
}

quarterly_apply_trade_changes_and_consume = {
	effect = {
		every_governorships = {
			# Actually apply the changes to stockpiles and get shortages
			CONSUME_all_stockpiles = yes
			GT_do_all_wealth_distribution = yes
			GT_save_final_quarterly_wealth_values = yes
		}
		CURRENCY_all_governorships_send_to_reserves = yes # Collect all the precious metals demanded for the gold and silver reserves
		if = {
			limit = {
				has_variable = official_currency
			}
			CURRENCY_private_purchase_or_sell_reserves = yes
			CURRENCY_apply_inflation_wealth_malus_country = yes
			CURRENCY_update_amt_circulated = yes
		}
		# CACHE OFT-REUSED VALUES
		set_variable = {
			name = TRADE_national_expenditure
			value = TRADE_national_expenditure
		}
		set_variable = {
			name = TRADE_national_income
			value = TRADE_national_income
		}

	}
}

quarterly_global_trade_food = {
	effect = {

		if = {
			limit = {
				NOT = { has_global_variable = done_quarterly_global_trade_food }
			}
			GT_split_do_global_trade_split = { type = food }
			set_global_variable = {
				name = done_quarterly_global_trade_food
				days = 1
			}
		}

	}
}
quarterly_global_trade_luxury = {
	effect = {

		if = {
			limit = {
				NOT = { has_global_variable = done_quarterly_global_trade_luxury }
			}
			GT_split_do_global_trade_split = { type = luxury }
			set_global_variable = {
				name = done_quarterly_global_trade_luxury
				days = 1
			}
		}

	}
}
quarterly_global_trade_luxury_2 = {
	effect = {

		if = {
			limit = {
				NOT = { has_global_variable = done_quarterly_global_trade_luxury_2 }
			}
			GT_split_do_global_trade_split = { type = luxury_2 }
			set_global_variable = {
				name = done_quarterly_global_trade_luxury_2
				days = 1
			}
		}

	}
}
quarterly_global_trade_3 = {
	effect = {

		if = {
			limit = {
				NOT = { has_global_variable = done_quarterly_global_trade_3 }
			}
			GT_split_do_global_trade_split = { type = 3 }
			set_global_variable = {
				name = done_quarterly_global_trade_3
				days = 1
			}
		}

	}
}
quarterly_global_trade_4 = {
	effect = {

		if = {
			limit = {
				NOT = { has_global_variable = done_quarterly_global_trade_4 }
			}
			GT_split_do_global_trade_split = { type = 4 }
			set_global_variable = {
				name = done_quarterly_global_trade_4
				days = 1
			}
		}

	}
}

quarterly_global_trade_5 = {
	effect = {

		if = {
			limit = {
				NOT = { has_global_variable = done_quarterly_global_trade_5 }
			}
			GT_split_do_global_trade_split = { type = 5 }
			set_global_variable = {
				name = done_quarterly_global_trade_5
				days = 1
			}
		}

	}
}

quarterly_global_trade_6 = {
	effect = {

		if = {
			limit = {
				NOT = { has_global_variable = done_quarterly_global_trade_6 }
			}
			GT_split_do_global_trade_split = { type = 6 }
			set_global_variable = {
				name = done_quarterly_global_trade_6
				days = 1
			}
		}

	}
}