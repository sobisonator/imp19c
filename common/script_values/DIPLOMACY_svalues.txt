DIPLOMACY_power = {
	# Scope: Country
	# Function: Get the power rating of the country

	value = DIPLOMACY_power_from_economy
	add = DIPLOMACY_power_from_military
	add = DIPLOMACY_power_from_tech
	add = DIPLOMACY_power_from_subjects
	# TODO: Add diplomacy power from prestige

	# Subtract the deficit in administration capacity, if present
	if = {
		limit = {
			ADMIN_available_country < 0
		}
		add = ADMIN_available_country
	}

	# Multiply by currency power
	if = {
		limit = {
			has_variable = official_currency
		}
		multiply = {
			value = 1
			add = CURRENCY_power_trade_bonus_cached
		}
	}

	min = 0
}

DIPLOMACY_power_from_subjects = {
	value = {
		every_subject = {
			limit = {
				NOR = {
					is_subject_type = tributary
					is_subject_type = nominal_vassal
				}
			}
			add = DIPLOMACY_power
		}
	}
}

DIPLOMACY_power_from_economy = {
	value = {
		value = WEALTH_total_private_moveable_wealth
		multiply = {
			value = WEALTH_national_per_capita
			multiply = 0.01
		}
	}
	add = {
		value = TRADE_percentage_of_global_shipping
		multiply = 10000
	}
	add = TRADE_activity_value
	if = {
		limit = {
			has_variable = official_currency
		}
		if = {
			limit = {
				THIS = var:official_currency.var:originator_country
			}
			add = {
				value = var:official_currency.var:CURRENCY_power_cached
				multiply = 0.25
			}
		}
	}
}

DIPLOMACY_power_from_military = {
	value = {
		add = {
			value = manpower 
			multiply = {
				value = 0.2
				add = {
					value = military_tech
					multiply = 0.02
				}
			}
		}
	}
}

DIPLOMACY_power_from_tech = {
	value = 1
	add = {
		value = oratory_tech
		add = military_tech
		add = civic_tech
		add = religious_tech
		multiply = 50
	}
}

DIPLOMACY_insignificant_threshold = {
	# Scope: Country
	# Function: The threshold under which countries should not be included in global power calculations
	# CURRENTLY HAS NO USE
	value = 100
}

## REGIONAL DIPLOMACY POWER

# TODO: Probably make this a scripted effect so it's templated
# TODO: Give some kind of bonus for home turf
## ^ Idea for the above bonus: give a 1+.% bonus multiplier to DIPLOMACY_power based on the % of your GDP in that tradezone

DIPLOMACY_global_power_score_threshold = {
	# Scope: Any
	# Function: The threshold for a country to be ranked among the top global powers
	# This score is derived from the country's ranking in tradezones around the world
	value = 16
}

DIPLOMACY_global_power_score = {
	# Scope: Country
	# Function: This country's global power score
	# Relies on DIPLOMACY_get_top_players_tradezone having been run

	value = 0
	# Tiebreaker
	#value = DIPLOMACY_power
	#multiply = 0.001

	every_province = { # Every tradezone
		limit = {
			has_variable = TZ_name
		}
		if = {
			limit = {
				var:DIPLOMACY_power_n1 = PREV
			}
			add = 10
		}
		else_if = {
			limit = {
				var:DIPLOMACY_power_n2 = PREV
			}
			add = 9
		}
		else_if = {
			limit = {
				var:DIPLOMACY_power_n3 = PREV
			}
			add = 8
		}
		else_if = {
			limit = {
				var:DIPLOMACY_power_n4 = PREV
			}
			add = 7
		}
	}
}

DIPLOMACY_show_colonial_canton = {
	value = 1
	if = {
		limit = {
			has_global_variable = tradezone_setup_done
			trigger_if = {
				limit = {
					has_global_variable = tradezone_setup_done
					# trigger after in-game setup, to prevent errors due to invalid tags
				}
				is_subject = yes
		        trigger_if = {
		            limit = {
		                is_subject = yes
		            }
		            NOT = {
		                overlord = c:NED
		                tag = FRG
		            }
		            OR = {
		                NOT = {
		                    overlord = c:SPA
		                    overlord = c:POR
		                }
		                capital_scope.governorship.var:trade_center = {
		                    OR = {
		                        has_variable = is_southern_africa_tradezone
		                        has_variable = is_east_africa_tradezone
		                        has_variable = is_west_africa_tradezone
		                    }
		                }
		            }
		            OR = {
		                is_subject_type = client_colony
		                is_subject_type = autonomous_colony

		                # Certain royal unions
		                AND = {
		                    OR = {
		                        overlord = {
		                            OR = {
		                                religion = orthodox
		                                religion = anglican
		                                religion = lutheran
		                                religion = evangelical
		                            }
		                        }
		                    }
		                    
		                    NOT = {
		                        has_variable = member_of_federation
		                    }
		                    is_subject_type = royal_union
		                    DIPLOMACY_power < 200
		                }
		            }
		        }
			}
		}
		value = 2
	}
}

GFX_rectangular_flag_svalue = {
	value = 2
}

GFX_square_flag_svalue = {
	value = 3
}

GFX_triangular_flag_svalue = {
	value = 4
}

GFX_curved_flag_svalue = {
	value = 5
}

GFX_bumpy_flag_svalue = {
	value = 6
}

GFX_pacman_flag_svalue = {
	value = 7
}

DIPLOMACY_flag_shape = {
	value = GFX_rectangular_flag_svalue
	if = {
		limit = {
			exists = yes
			num_of_cities > 0
		}
		if = {
			limit = {
				OR = {
					tag = SWI
					tag = RSH
					tag = NEU
					tag = PAP
					tag = SCU
					# japan
					tag = TKG
					tag = AIN
					tag = AZU
					tag = SHZ
					tag = MAE
					tag = TGU
					tag = SKE
					tag = NMB
					tag = DTE
					tag = SNI
					tag = SBT
					tag = SHM
					tag = HIT
					tag = TAT
					tag = JZI
					tag = FUK
					tag = IZU
					tag = MED
					tag = OWR
					tag = HDA
					tag = TSU
					tag = KII
					tag = ECH
					tag = OBM
					tag = MYZ
					tag = HJI
					tag = HCH
					tag = TKU
					tag = YCH
					tag = KTO
					tag = UWA
					tag = OKA
					tag = ASN
					tag = IWM
					tag = CSU
					tag = SGA
					tag = BGO
					tag = NTO
					tag = HKW
					#china
					tag = MKD
					tag = MNC
					tag = HLJ
					tag = ILI
					tag = KBD
					tag = ULS
					tag = KML
					tag = MGA
					# italy
					tag = CSP
				}
			}
			value = GFX_square_flag_svalue
		}
		else_if = {
			limit = {
				OR = {
					tag = CHI
					tag = KHL
				}
			}
			value = GFX_triangular_flag_svalue
		}
		else_if = {
			limit = {
				OR = {
					primary_culture = somali
					primary_culture = oromo
					primary_culture = sidamic
					primary_culture = afar
					primary_culture = beja
					primary_culture = fulani
					primary_culture = hausa
					primary_culture = loko
					primary_culture = mende
					primary_culture = mossi
					primary_culture = baoule
					primary_culture = samogo_soninke
					primary_culture = zialo
					primary_culture = gbandi
					primary_culture = bissa
					primary_culture = kpelle
					tag = CBI
				}
				NOT = {
					has_variable = post_colonial_rectangular_flag
				}
			}
			value = GFX_curved_flag_svalue
		}
		else_if = {
			limit = {
				OR = {
					tag = TUN
				}
			}
			value = GFX_bumpy_flag_svalue
		}
		else_if = {
			limit = {
				OR = {
					tag = MRT
					tag = HOL
					tag = MNS
					AND = {
						is_subject = yes
						trigger_if = {
							limit = {
								is_subject = yes
							}
							overlord = c:MRT
							OR = {
								capital_scope.region = region:Central_India
								capital_scope.region = region:South_India
							}
						}
					}
				}
			}
			value = GFX_pacman_flag_svalue
		}
	}

}

DIPLOMACY_play_max_progression = {
	# Scope: Province
	# Function: The max progression value a diplomatic play can have before the finale event is forced
	# Typically measured in number of on_action ticks a play has been through
	# Ticks happen every month, so this is 20 years
	# But a diplomatic play can be progressed or regressed by events as well
	value = 240
}

DIPLOMACY_play_progress_small = {
	value = DIPLOMACY_play_max_progression
	divide = 100
}

DIPLOMACY_play_progress_medium = {
	value = DIPLOMACY_play_max_progression
	divide = 50
}

DIPLOMACY_play_progress_large = {
	value = DIPLOMACY_play_max_progression
	divide = 10
}

DIPLOMACY_play_progression_percent = {
	# Scope: Province
	# Function: Gets the % of progression out of possible max
	if = {
		limit = {
			var:diplomatic_play_progression > 0
		}
		value = var:diplomatic_play_progression
		divide = DIPLOMACY_play_max_progression
	}
	else = {
		value = 0
	}
	
}

# Diplomatic play attitude ratings
# If the value is outside of these (i.e., further from 0 than from the value), then the instigator is considered to be in this state
# If the value is within these, then the instigator is considered to be neutral
DIPLOMACY_play_attitude_friendly = {
	value = 20
}
DIPLOMACY_play_attitude_hostile = {
	value = -20
}
# Diplomatic play war ratings
# If the value is above these, then the instigator is considered to be in this state
DIPLOMACY_play_war_willing = {
	value = 0
}
DIPLOMACY_play_war_considering = {
	value = -7000
}