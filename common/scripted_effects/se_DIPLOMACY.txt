DIPLOMACY_cache_diplomatic_power_country_every_TZ = {
	# Scope: Country
	# Function: Cache this country's diplomatic power in every TZ

}

DIPLOMACY_get_power_in_play_TZ = {
	# Scope: Any (directed to trade center province scope)
	# Function: Get the total amount of diplomatic power in play in the given TZ
	global_var:global_$tradezone$_tradezone = {
		set_variable = {
			name = TZ_power_in_play
			value = {
				every_country = {
					add = var:DIPLOMACY_power_$tradezone$
				}
			}
		}
	}
}

DIPLOMACY_get_top_players_tradezone = {
	# Scope: Any (directed to trade center province scope)
	# Function: Save the top X powers in a tradezone into respective variables
	global_var:global_$tradezone$_tradezone = {
		save_scope_as = TZ_scope
		remove_variable = DIPLOMACY_power_n1
		remove_variable = DIPLOMACY_power_n2
		remove_variable = DIPLOMACY_power_n3
		remove_variable = DIPLOMACY_power_n4
		ordered_country = {
			order_by = var:DIPLOMACY_power_$tradezone$

			max = 4 # Adjust as needed based on how many ranked powers to have in a region

			save_scope_as = power_scope

			scope:TZ_scope = {
				if = {
					limit = {
						scope:TZ_scope = {
							NOT = { has_variable = DIPLOMACY_power_n1 }
						}
					}
					set_variable = {
						name = DIPLOMACY_power_n1
						value = scope:power_scope
					}
				}
				else_if = {
					limit = {
						scope:TZ_scope = {
							NOT = {has_variable = DIPLOMACY_power_n2}
						}
					}
					set_variable = {
						name = DIPLOMACY_power_n2
						value = scope:power_scope
					}
				}
				else_if = {
					limit = {
						scope:TZ_scope = {
							NOT = {has_variable = DIPLOMACY_power_n3}
						}
					}
					set_variable = {
						name = DIPLOMACY_power_n3
						value = scope:power_scope
					}
				}
				else_if = {
					limit = {
						scope:TZ_scope = {
							NOT = {has_variable = DIPLOMACY_power_n4}
						}
					}
					set_variable = {
						name = DIPLOMACY_power_n4
						value = scope:power_scope
					}
				}
			}

		}
	}
	
	
}

DIPLOMACY_cache_country_power_tradezone = {
	# Scope: Country
	# Function: Save the country's power in each tradezone, if above 100
	save_scope_as = country_scope
	set_variable = {
		name = DIPLOMACY_power_$tradezone$
		value = {
			value = DIPLOMACY_power
			multiply = TZ_penetration_$tradezone$
			
			# Bonus multiplier for home-turf, % of this country's GDP in the TZ
			# e.g. if this TZ contains 75% of the country's wealth, multiply the power rating by 1.75
			#multiply = {
			#	value = 1
			#	add = {
			#		value = 0
			#		every_governorships = {
			#			#if = {
			#				limit = {
			#					capital_scope = {
			#						$tradezone$_tradezone = { PROVINCE = yes }
			#					}
			#				}
			#				add = {
			#					value = WEALTH_governorship_total
			#				}
			#			#}
			#		}
			#		divide = {
			#			value = var:WEALTH_total_private_moveable_wealth
			#			divide = 128
			#		}
			#	}

			}
		}
	}
}

DIPLOMACY_add_cached_subject_power_tradezone = {
	# Scope: Country
	# Function: Add all subjects' cached power to suzerains
	set_variable = {
		name = DIPLOMACY_power_from_subjects_$tradezone$
		value = {
			value = 0
			every_subject = {
				add = var:DIPLOMACY_power_$tradezone$
				every_subject = {
					add = var:DIPLOMACY_power_$tradezone$
				}
			}
		}
	}
}

DIPLOMACY_finalise_cached_subject_power_tradezone = {
	# Scope: Country
	# Function: Combine subjects' cached power to suzerain's tradezone power value
	change_variable = {
		name = DIPLOMACY_power_$tradezone$
		add = var:DIPLOMACY_power_from_subjects_$tradezone$
	}
	remove_variable = DIPLOMACY_power_from_subjects_$tradezone$
}

DIPLOMACY_complete_play = {
	$diplomatic_play$ = {
		save_scope_as = diplomatic_play
	}
}

DIPLOMACY_get_top_global_powers = {
	# Scope: Any country, iterate through tradezones
	# Function: Get the top powers in the world. Every country with more than 22
	clear_global_variable_list = global_powers_list
	ordered_country = {
		order_by = DIPLOMACY_global_power_score

		max = 10

		limit = {
			is_subject = no
		}

		if = {
			limit = {
				DIPLOMACY_global_power_score > DIPLOMACY_global_power_score_threshold
			}
			save_scope_as = global_power_scope
			add_to_global_variable_list = {
				name = global_powers_list
				target = scope:global_power_scope
			}
		}
	}
}

DIPLOMACY_update_global_power_status = {
	every_country = {
		every_tradezone_complex = {
			APPLY = DIPLOMACY_cache_country_power_tradezone
		}
	}
	every_country = {
		every_tradezone_complex = {
			APPLY = DIPLOMACY_add_cached_subject_power_tradezone
		}
	}
	every_country = {
		every_tradezone_complex = {
			APPLY = DIPLOMACY_finalise_cached_subject_power_tradezone
		}
	}
	every_tradezone_complex = {
		APPLY = DIPLOMACY_get_power_in_play_TZ
	}
	every_tradezone_complex = {
		APPLY = DIPLOMACY_get_top_players_tradezone
	}

	DIPLOMACY_get_top_global_powers = yes

}

### DIPLOMATIC PLAY ACTIONS
DIPLOMACY_play_update_spend = {
	# Scope: Diplomatic_play
}

DIPLOMACY_test_event = {
	# Scope: Country
	# Function: Test a diplomatic play event in a random play in which the country is an instigator
	save_scope_as = test_instigator
	random_province = {
		limit = {
			has_variable = play_instigator
			trigger_if = {
				limit = {
					has_variable = play_instigator
				}
				var:play_instigator = scope:test_instigator
			}
		}
		DIPLOMACY_trigger_play_event = {
			pov = var:play_instigator
			id = diplomatic_play.1
			days = 0
		}
	}
}

DIPLOMACY_kickoff_play_event = {
	# Saves 1 line in triggering play events when called in the random selection
	if = {
		limit = {
			flag:$pov$ = flag:random_supporter_target
		}
		random_in_list = {
			variable = play_observers_support_target

			save_scope_as = pov_scope
		}
		DIPLOMACY_trigger_play_event = {
			pov = scope:pov_scope
			id = $id$
			days = { 0 28 }
		}
	}
	else_if = {
		limit = {
			flag:$pov$ = flag:random_supporter_instigator
		}
		random_in_list = {
			variable = play_observers_support_instigator

			save_scope_as = pov_scope
		}
		DIPLOMACY_trigger_play_event = {
			pov = scope:pov_scope
			id = $id$
			days = { 0 28 }
		}
	}
	else = {
		DIPLOMACY_trigger_play_event = {
			pov = $pov$
			id = $id$
			days = { 0 28 }
		}
	}

}

DIPLOMACY_trigger_play_event = {
	# Scope: Province
	# Function Triggers the given $id$ event with all the necessary scopes for a diplomatic play event
	
	# TODO: Extend this to select an event random-weighted based on the conditions in the play, attitude of the foreign minister or ruler, and any other factors.

	save_scope_as = diplomatic_play
	var:play_target_country = {
		save_scope_as = play_target_country
	}
	var:play_instigator = {
		save_scope_as = play_instigator
		if = {
			limit = {
				any_character = {
					OR = {
						has_office = secretary_r_foreign_affairs
						has_office = office_foreign_minister
						has_office = office_arbitrator
					}
				}
			}
			random_character = {
				limit = {
					OR = {
						has_office = secretary_r_foreign_affairs
						has_office = office_foreign_minister
						has_office = office_arbitrator
					}
				}
				save_scope_as = foreign_minister
			}
		}
		else = {
			ruler = {
				save_scope_as = foreign_minister
			}
		}
	}

	$pov$ = {
		save_scope_as = actor
		trigger_event = {
			id = $id$
			days = $days$
		}
	}
	
}

DIPLOMACY_notify_player = {
	# Scope: Any
	# Function: Notify the player(s) of the event which has just occurred
	every_country = {
		limit = {
			# TODO: Add to this limit so that the player is not notified of their own events
			# This is left in for testing purposes
			is_ai = no
		}
		trigger_event = {
			id = $event$
		}
	}
}

DIPLOMACY_add_colonial_outpost = {
	# Scope: Province
	# Function: Add a colonial outpost and assign the owner
	add_province_modifier = {
		name = colonial_outpost
        duration = -1
    }
    set_variable = {
    	name = colonial_outpost_owner
    	value = $outpost_owner$
    }

}

DIPLOMACY_update_all_diplomatic_plays = {
	every_province = {
		limit = {
			has_variable = is_diplomatic_play
		}
		DIPLOMACY_trigger_diplomatic_play_event = yes
		DIPLOMACY_diplomatic_play_update_status = yes
	}
}

DIPLOMACY_diplomatic_play_update_status = {
	# Scope: Province (diplomatic play)
	# Function: All observers check their allegiance in a diplomatic play, and the play's balance of power and attitude is recalculated
	# Called: On diplomatic play update on_action

	save_scope_as = diplomatic_play

	# Update the diplomatic play's age
	change_variable = {
		name = diplomatic_play_progression
		add = 1
	}
	# If the diplomatic play is progressed, push it to its conculsion instead
	if = {
		limit = {
			var:diplomatic_play_progression > DIPLOMACY_play_max_progression
		}
		DIPLOMACY_complete_play = {
			diplomatic_play = scope:diplomatic_play
		}
	}
	# Otherwise, update all values
	else = {
		if = {
			limit = {
				NOT = {
					has_variable = diplomatic_play_reevaluated_recently
				}
			}
			AI_diplomatic_play_do_support_change = yes
			AI_assess_adversary = { 
				diplomatic_play = scope:diplomatic_play
				AI_target = scope:diplomatic_play.var:play_target_country
			}
			AI_diplomatic_play_evaluate_attitude = {
				diplomatic_play = scope:diplomatic_play
			}
			AI_diplomatic_play_evaluate_war = {
				diplomatic_play = scope:diplomatic_play
			}
			set_variable = {
				name = diplomatic_play_reevaluated_recently
				days = 365
			}
		}
	}
	

}

DIPLOMACY_modify_play_success = {
	# Scope: Province (diplomatic play)
	# Function: Modify the success rating of a diplomatic play, to a maximum of 100
	if = {
		limit = {
			NOT = { $amt$ = 0 }
		}
		set_local_variable = {
			name = succes_mulitplier
			value = {
				# Get reciprocal of balance of power
				value = 1
				divide = var:AI_play_power_balance_instigator_root
				# Invert the reciprocal
				subtract = 1
				multiply = -1
				# Add to 1
				add = 1
			}
		}

		if = {
			limit = {
				$amt$ > 0
			}
			change_variable = {
				name = diplomatic_play_success
				add = {
					value = $amt$
					multiply = local_var:success_multiplier
				}
			}
			if = {
				limit = {
					var:diplomatic_play_success > 100
				}
				set_variable = {
					name = diplomatic_play_success
					value = 100
				}
			}
		}
		else = {
			change_variable = {
				name = diplomatic_play_success
				add = {
					value = $amt$
					divide = local_var:success_multiplier
				}
			}
			if = {
				limit = {
					var:diplomatic_play_success < 0
				}
				set_variable = {
					name = diplomatic_play_success
					value = 0
				}
			}
		}
	}
	
}

DIPLOMACY_progress_play = {
	# Scope: Province (diplomatic play)
	# Function: Advance the progress and success rating (both optionally 0) of the play
	DIPLOMACY_modify_play_success = {
		amt = $success$
	}
	if = {
		limit = {
			NOT = { $progress$ = 0 }
		}
		change_variable = {
			name = diplomatic_play_progression
			add = $progress$
		}
	}
}

DIPLOMACY_trigger_diplomatic_play_war = {
	# Scope: Diplomatic play province
	# Function: Trigger a war involving all observers who have picked a side in a diplomatic play
	save_scope_as = diplomatic_play
	var:play_instigator = {
		FUNC_declare_war_with_wargoal_province = {
	        war_goal = conquer_wargoal
	        province = scope:diplomatic_play.var:play_target_area
	        target = scope:diplomatic_play.var:play_target_country
	    }
	    every_in_list = {
	    	variable = play_observers_support_instigator
	    	add_to_war = {
				target = scope:current_war_scope
				attacker = yes
				leader = no
			}
	    }
	    every_in_list = {
	    	variable = play_observers_support_target
	    	add_to_war = {
				target = scope:current_war_scope
				attacker = no
				leader = no
			}
	    }
	}
	
}

DIPLOMACY_trigger_diplomatic_play_event = {
	# Scope: Province (diplomatic play)
	# Function: Trigger a diplomatic play event according to the status of the play
	
	# Events are triggered by a combination of success chance and progress
	# The war willingness and play attitude are also taken into account

	# EARLY EVENTS
	if = {
		limit = {
			var:diplomatic_play_progression < DIPLOMACY_play_progress_one_third
		}
		random_list = {
			1 = { 
				DIPLOMACY_kickoff_play_event = {
					id = minor_border_discussion.1
					pov = var:play_instigator
				} 
			}
			1 = { 
				DIPLOMACY_kickoff_play_event = {
					id = agitator_sponsorship.1
					pov = var:play_instigator
				} 
			}
			1 = { 
				DIPLOMACY_kickoff_play_event = {
					id = send_settlers.1
					pov = var:play_instigator
				} 
			}
			1 = { # Tangier crisis type (target supporter head of state visits target to promote target sovereignty)
				DIPLOMACY_kickoff_play_event = {
					id = head_of_state_visit_play_area.1
					pov = random_supporter_target
				} 
			}
		}
	}
	# MIDDLE EVENTS
	else_if = {
		limit = {
			AND = {
				var:diplomatic_play_progression >= DIPLOMACY_play_progress_one_third
				var:diplomatic_play_progression <= DIPLOMACY_play_progress_two_thirds
			}
		}
		random_list = {
			1 = { # Tangier crisis type (target supporter head of state visits target to promote target sovereignty)
				DIPLOMACY_kickoff_play_event = {
					id = head_of_state_visit_play_area.1
					pov = random_supporter_target
				} 
			}
			1 = { 
				DIPLOMACY_kickoff_play_event = {
					id = agitator_sponsorship.1
					pov = var:play_instigator
				} 
			}
			1 = { 
				DIPLOMACY_kickoff_play_event = {
					id = send_settlers.1
					pov = var:play_instigator
				} 
			}
		}

	}
	# LATE EVENTS
	else_if = {
		limit = {
			var:diplomatic_play_progression > DIPLOMACY_play_progress_two_thirds
		}
		random_list = {
			1 = { # Fashoda type
				DIPLOMACY_kickoff_play_event = {
					id = diplomatic_play.1
					pov = var:play_instigator
				} 
			}
			1 = { 
				DIPLOMACY_kickoff_play_event = {
					id = agitator_sponsorship.1
					pov = var:play_instigator
				} 
			}
			1 = { # Agadir crisis type event event (a supporter of the target sends a gunboat to circle the target area)
				DIPLOMACY_kickoff_play_event = {
					id = agadir_crisis_type.1
					pov = random_supporter_target
				} 
			}
		}
	}
}

DIPLOMACY_trigger_diplomatic_play_finale_event = {
	# Scope: Province (diplomatic play)
	# Function: Trigger the final event for a diplomatic play, based on the conditions of the play

	# Target country turned into protectorate (major power imbalance, colonial type play)
	# Target area ceded to instigator (moderate power imbalance, colonial type play)
	# Instigator creates a rebellion in the target area, as protectorate of itself (major power imbalance, poor relations, low stability in the target country)
	# Instigator creates an independent rebellion in the target area (moderate power imbalanace, poor relations, low stability in the target country)
	# Instigator declares war on the target country (high likelihood of war, low infamy cost and stability cost to instigator)
	# Royal marriage between the two countries (Friendly, both monarchies)
	# Trade agreement between the two countries (Friendly, both AI)
}