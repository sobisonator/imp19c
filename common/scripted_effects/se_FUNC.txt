FUNC_clamp_variable = {
	# Scope: Any
	# Function: Set a max and min (optional) for the given variable
	# Special arguments
	# max_type and min_type should be '' if they're svalues, or 'var:' if they're variables
	# The variable to be bounded must not include it's var: prefix

	if = {
		limit = { NOT = { $max_type$$max$ = 0 } }
		set_local_variable = {
			name = l_comparison_diff
			value = $max_type$$max$
		}
		change_local_variable = {
			name = l_comparison_diff
			subtract = var:$variable$
		}
		if = {
			limit = {
				local_var:l_comparison_diff < 0
			}
			set_variable = {
				name = $variable$
				value = $max_type$$max$
			}
		}
	}

	

	if = {
		limit = { NOT = { $min_type$$min$ = 0 } }
		set_local_variable = {
			name = l_comparison_diff
			value = var:$variable$
		}
		change_local_variable = {
			name = l_comparison_diff
			subtract = $min_type$$min$
		}
		if = {
			limit = {
				local_var:l_comparison_diff < 0
			}
			set_variable = {
				name = $variable$
				value = $min_type$$min$
			}
		}
	} 

}

FUNC_add_modifier_stack = {
	# Credit to Jay DoubleU in Imperator mod coop
	# Scope: $TYPE$
    if = {
        limit = {
            has_$TYPE$_modifier = $MOD$
        }
        remove_$TYPE$_modifier = $MOD$
    }
    while = {
        count = $NUM$
        add_$TYPE$_modifier = {
            name = $MOD$
            mode = add
            duration = $DUR$
        }
    }
}

FUNC_add_province_modifier_stack = {
	# Credit to Jay DoubleU in Imperator mod coop
	# Scope: Province
    if = {
        limit = {
            has_province_modifier = $MOD$
        }
        remove_province_modifier = $MOD$
    }
    while = {
        count = $NUM$
        add_province_modifier = {
            name = $MOD$
            mode = add
            duration = $DUR$
        }
    }
}

FUNC_add_state_modifier_stack = {
	# Credit to Jay DoubleU in Imperator mod coop
	# Scope: Province
    if = {
        limit = {
            has_state_modifier = $MOD$
        }
        remove_state_modifier = $MOD$
    }
    while = {
        count = $NUM$
        add_state_modifier = {
            name = $MOD$
            mode = add
            duration = $DUR$
        }
    }
}

FUNC_visualise_tradezones = {
	# Scope: any
	# Function: Make all tradezones owned by tags, so that they can be quickly visualised
	every_trade_center = {
		switch = {
			trigger = has_variable

			is_india_tradezone = {
				every_province = {
					limit = {
						india_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:MRT
				}
			}
			is_east_north_america_tradezone = {
				every_province = {
					limit = {
						east_north_america_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:USA
				}
			}
			is_west_north_america_tradezone = {
				every_province = {
					limit = {
						west_north_america_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:MEX
				}
			}
			is_caribbean_tradezone = {
				every_province = {
					limit = {
						caribbean_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:MSK
				}
			}
			is_west_south_america_tradezone = {
				every_province = {
					limit = {
						west_south_america_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:CHL
				}
			}
			is_east_south_america_tradezone = {
				every_province = {
					limit = {
						east_south_america_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:BRZ
				}
			}
			is_south_east_asia_tradezone = {
				every_province = {
					limit = {
						south_east_asia_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:SAM
				}
			}
			is_indo_china_tradezone = {
				every_province = {
					limit = {
						indo_china_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:LPG
				}
			}
			is_yellow_sea_tradezone = {
				every_province = {
					limit = {
						yellow_sea_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:KOR
				}
			}
			is_southern_africa_tradezone = {
				every_province = {
					limit = {
						southern_africa_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:XHO
				}
			}
			is_west_africa_tradezone = {
				every_province = {
					limit = {
						west_africa_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:ATI
				}
			}
			is_east_africa_tradezone = {
				every_province = {
					limit = {
						east_africa_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:BOE
				}
			}
			is_middle_east_tradezone = {
				every_province = {
					limit = {
						middle_east_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:ERI
				}
			}
			is_western_steppe_tradezone = {
				every_province = {
					limit = {
						western_steppe_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:KHV
				}
			}
			is_eastern_steppe_tradezone = {
				every_province = {
					limit = {
						eastern_steppe_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:TNN
				}
			}
			is_upper_yangtzi_tradezone = {
				every_province = {
					limit = {
						upper_yangtzi_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:MKD
				}
			}
			is_atlantic_seaboard_tradezone = {
				every_province = {
					limit = {
						atlantic_seaboard_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:GBR
				}
			}
			is_central_europe_tradezone = {
				every_province = {
					limit = {
						central_europe_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:HZS
				}
			}
			is_west_mediterranean_tradezone = {
				every_province = {
					limit = {
						west_mediterranean_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:MCO
				}
			}
			is_baltic_tradezone = {
				every_province = {
					limit = {
						baltic_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:SWE
				}
			}
			is_east_europe_tradezone = {
				every_province = {
					limit = {
						east_europe_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:KRA
				}
			}
			is_east_mediterranean_tradezone = {
				every_province = {
					limit = {
						east_mediterranean_tradezone = { PROVINCE = yes }
					}
					set_owned_by = c:SRB
				}
			}
		}
	}
}

GT_factor_raw_input_costs_clothing = {
	# Scope: Tradezone province
	# Function: Add the per-unit price of raw tradegoods for the given manufactured $tradegood$
	change_variable = {
		name = local_price_clothing
		add = {
			add = {
				value = var:local_price_textile_fibres
				multiply = INDUSTRY_demand_importance_clothing_textile_fibres
			}
			add = {
				value = var:local_price_dye
				multiply = INDUSTRY_demand_importance_clothing_dye
			}
			add = {
				value = var:local_price_livestock
				multiply = INDUSTRY_demand_importance_clothing_livestock
			}
		}
	}
}

FUNC_declare_war_with_wargoal_province = {
	# Scope: Country
	# Function: Declares war on target country while "excluding protected_when_attacked = no" subjects
	# Also brings in colonies, autonomous governorships and territories
	# TODO: Undo vassal colours if the declarer is a former vassal
	save_scope_as = instigator
	save_scope_as = actor
	$province$ = {
		save_scope_as = FUNC_target_province
	}
	$target$ = {
		save_scope_as = FUNC_war_target
	}
	$target$ = {
		# Momentarily remove tributary status from self
		if = {
			limit = {
				is_subject = yes
			}
			save_scope_as = vassal_to_remove
			# Save the subject type
			if = {
				limit = {
					OR = {
						is_subject_type = tributary
						is_subject_type = sinosphere_tributary
					}
				}
				set_local_variable = tributary_was_released
				overlord = {
					save_scope_as = overlord_to_reinstate
					release_subject = scope:vassal_to_remove
				}
			}
		}
	}
	declare_war_with_wargoal = {
		war_goal = $war_goal$
		province = $province$
		target = $target$
	}

	random_current_war = {
		limit = {
			any_war_participant = { THIS = scope:instigator }
			any_war_participant = { THIS = $target$ }
			is_war_leader = scope:instigator
			is_war_leader = $target$
		}
		save_scope_as = current_war_scope
	}

	every_subject = {
		limit = {
			OR = {
				is_subject_type = client_colony
				is_subject_type = autonomous_colony
				is_subject_type = autonomous_governorship
				is_subject_type = semi_autonomous_governorship
				is_subject_type = subsidiary_ally
				is_subject_type = feudatory
				is_subject_type = territory
			}
		}
		add_to_war = {
			target = scope:current_war_scope
			attacker = yes
			leader = no
		} 
	}
	# Consider an effect for removing great power allies from wars targeting minor countries

	if = {
		limit = {
			always = no # Disabled for now, as this immediately ends the war
			has_local_variable = tributary_was_released
		}
		scope:overlord_to_reinstate = {
			make_subject = {
				target = scope:vassal_to_remove
				type = tributary
			}
		}
	}
	every_country = {
		limit = {
			is_ai = no
		}
		trigger_event = { id = AI_notification_event.6 }
	}
}

FUNC_make_subject = {
	# Scope: Country
	# Function: Replacer for vanilla make_subject, with bells and whistles
	$overlord$ = {
		make_subject = {
			target = $target$
			type = $type$
		}
	}

	$target$ = {
		set_variable = {
			name = latest_overlord
			value = $overlord$
		}
	}
	
	$overlord$ = {
		change_color_effect = { color = color }
	}
	
}

FUNC_set_conquered_by = {
	# Scope: Province
	# Function: Replacer for vanilla set_conquered_by, ignores uninhabitable provinces
	# Also ignores provinces already owned by $grantee$
	if = {
		limit = {
			is_uninhabitable = no
			trigger_if = {
				limit = {
					has_owner = yes
				}
				NOT = {
					owner = $grantee$
				}
			}
		}
		set_conquered_by = $grantee$
	}
}

FUNC_give_hos = {
	$target$ = {
		set_variable = {
			name = monarch_character
			value = $character$
		}
	}
}

FUNC_setup_new_country = {
	# Scope: Country
	# Function: Set up all the data needed by imp19c in a newly spawned country

	# Tax and spending rates
	INCOME_set_country_tax_and_spending = {
		excise_duty_essentials = 0.075 # TODO: make this a context-sensitive svalue
		excise_duty_essentials_aka = 075
		property_tax = 0.03 # TODO: make this a context-sensitive svalue
		property_tax_aka = 03
		income_tax = 0.03 # TODO: make this a context-sensitive svalue
		income_tax_aka = 03
		tariffs = 0.075 # TODO: make this a context-sensitive svalue
		tariffs_aka = 075
		military_supplies_spending = 1 # 100%
		navy_supplies_spending = 1 # 100%
		public_welfare_spending = 0.25 # 25%
	}

	# Governorship-scope economy variables
	every_governorships = {
		INDUSTRY_setup_all_factory_assignments = yes
		TRADE_set_internal_trade_scope = yes
		WEALTH_setup_governorship = yes
		# TODO: Ensure that if governorships are split by the formation of a new country, that the wealth is split too
		GOODS_update_governorship_local_goods = yes
  		GOODS_setup_governorship_stockpiles = yes
  		TRADE_update_governorship_TZs = yes
  		CONSUME_setup_all_variables = yes
	}

	# Precious metal reserves
	CURRENCY_country_setup_reserves = {
		gold_reserve_size = CURRENCY_base_starting_reserve_gold # hundreds lb
		gold_reserve_accumulation_rate = CURRENCY_base_starting_reserve_accumulation_rate_gold # hundreds lb

		silver_reserve_size = CURRENCY_base_starting_reserve_silver # hundreds lb
		silver_reserve_accumulation_rate = CURRENCY_base_starting_reserve_accumulation_rate_silver # hundreds lb
	}

	# Education
	EDU_setup_education_numbers_all_governorships = yes
	EDU_set_t2_national_bonus_from_universities = yes
	EDU_set_starting_education_numbers_all_governorships = yes
	EDU_set_available_for_trade = { tier = t2 }
	EDU_set_education_available_from_trade = { tier = t2 }
	EDU_set_t2_research_bonus = yes

	# Treasury and government stockpiles
	MILITARY_setup_supplies = yes
	INCOME_collect_all_taxes_country = yes
	INCOME_update_treasury_country = yes
	WEALTH_cache_national_wealth = yes
	INCOME_calculate_and_distribute_military_procurement_wealth_owed = yes

	# Governorship stockpiles
	FUNC_every_governorship_update_tradegood_stockpiles = yes
}

FUNC_every_governorship_update_tradegood_stockpiles = {
	every_governorships = {
		every_tradegood_complex = {
			APPLY = FUNC_set_tradegood_stockpiles_from_production
		}
	}
}

FUNC_set_tradegood_stockpiles_from_production = {
	# Scope: Governorship
	# Function: Add the production count to the given tradegood stockpile
	change_variable = {
		name = $tradegood$_stockpile
		add = GOODS_governorship_$tradegood$_produced
	}
}