## Scripts governing the income earned by the government

INCOME_set_country_tax_and_spending = {
	# Scope: Country
	# Function: Set all the tax rates at a country level
	# Values are 0-1 (percentage)
	# Values should be somewhat dynamic
	# Called: On setup
	INCOME_set_tax_modifier = {
		category = excise_duty_essentials
		amount = $excise_duty_essentials$
		amount_aka = $excise_duty_essentials_aka$

	}
	#set_variable = {
	#	name = INCOME_taxrate_excise_duty_luxuries
	#	value = 0.1
	#}
	INCOME_set_tax_modifier = {
		category = property_tax
		amount = $property_tax$
		amount_aka = $property_tax_aka$
	}
	INCOME_set_tax_modifier = {
		category = income_tax
		amount = $income_tax$
		amount_aka = $income_tax_aka$
	}
	INCOME_set_tax_modifier = {
		category = tariffs
		amount = $tariffs$
		amount_aka = $tariffs_aka$
	}
	# Spending
	set_variable = {
		name = INCOME_military_supplies_spending_rate
		value = $military_supplies_spending$
	}
	set_variable = {
		name = INCOME_navy_supplies_spending_rate
		value = $navy_supplies_spending$
	}
	set_variable = {
		name = INCOME_public_welfare_spending_rate
		value = $public_welfare_spending$
	}
}

INCOME_update_treasury_country = {
	# Scope: Country
	# Function: Modify the treasury based on the income and expenses values
	# Also set variables for cached GUI display purposes
	# Called: At game init and every quarterly pulse
	set_variable = {
		name = INCOME_national_total_quarterly
		value = INCOME_national_total_quarterly
	}
	add_treasury = var:INCOME_national_total_quarterly

	set_variable = {
		name = INCOME_national_total_from_tax
		value = INCOME_national_total_from_tax
	}
	set_variable = {
		name = INCOME_national_total_from_tax_and_tariff
		value = {
			value = var:INCOME_national_total_from_tax
			every_governorships = {
				add = INCOME_governorship_tariffs_total_positive
			}
		}
	}
	set_variable = {
		name = INCOME_national_total_from_tariffs_and_shipping
		value = INCOME_national_total_from_tariffs_and_shipping
	}
	set_variable = {
		name = INCOME_national_total_production
		value = INCOME_national_total_production
	}
	set_variable = {
		name = INCOME_national_total_from_subjects
		value = INCOME_national_total_from_subjects
	}


	set_variable = {
		name = INCOME_cost_administrator_wages_country
		value = INCOME_cost_administrator_wages_country
	}
	set_variable = {
		name = INCOME_cost_military_wages_country
		value = INCOME_cost_military_wages_country
	}
	set_variable = {
		name = INCOME_cost_military_supplies_country
		value = INCOME_cost_military_supplies_country
	}
	set_variable = {
		name = INCOME_cost_navy_supplies_country
		value = INCOME_cost_navy_supplies_country
	}
	set_variable = {
		name = INCOME_cost_welfare_spending
		value = {
			value = INCOME_cost_poor_law_spending
			# Other costs TODO
		}
	}
	set_variable = {
		name = INCOME_cost_supplies_and_welfare_country
		value = {
			value = var:INCOME_cost_military_supplies_country
			add = var:INCOME_cost_navy_supplies_country
			add = var:INCOME_cost_welfare_spending
		}
	}
}

INCOME_collect_all_taxes_country = {
	# Scope: Country
	# Function: Deduct taxes from all governorship wealth pools.
	# This DOES NOT ADD TO TREASURY, that is handled by INCOME_update_treasury_country
	# Called: Quarterly
	INCOME_reset_quarterly_national_tax_income_all = yes
	every_governorships = {
		INCOME_deduct_all_taxes_from_wealth_governorship = yes
	}

	# TODO: Tax collection is affected by admin efficiency in states
}

INCOME_deduct_all_taxes_from_wealth_governorship = {
	INCOME_deduct_tax_from_wealth_governorship = {
		tax_type = excise_duty_essentials
	}
	INCOME_deduct_tax_from_wealth_governorship = {
		tax_type = property_tax
	}
	INCOME_deduct_tax_from_wealth_governorship = {
		tax_type = income_tax
	}
	INCOME_deduct_tax_from_wealth_governorship = {
		tax_type = tariffs
	}
}

INCOME_reset_quarterly_national_tax_income_all = {
	INCOME_reset_quarterly_national_tax_income = {
		tax_type = excise_duty_essentials
	}
	INCOME_reset_quarterly_national_tax_income = {
		tax_type = property_tax
	}
	INCOME_reset_quarterly_national_tax_income = {
		tax_type = income_tax
	}
	INCOME_reset_quarterly_national_tax_income = {
		tax_type = tariffs
	}
}

INCOME_reset_quarterly_national_tax_income = {
	set_variable = {
		name = INCOME_national_from_$tax_type$
		value = 0
	}
}

INCOME_deduct_tax_from_wealth_governorship = {
	# Scope: Governorship
	# Function: Remove the given $tax$ from each pop type's wealth pool in a governorship corresponding to the tax amount
	# Called: Every quarter
	if = {
		limit = {
			has_variable = upper_strata_wealth
		}
		change_variable = {
			name = upper_strata_wealth
			add = INCOME_governorship_$tax_type$_upper_strata
		}
		change_variable = {
			name = middle_strata_wealth
			add = INCOME_governorship_$tax_type$_middle_strata
		}
		change_variable = {
			name = lower_strata_wealth
			add = INCOME_governorship_$tax_type$_lower_strata
		}
		change_variable = {
			name = proletariat_wealth
			add = INCOME_governorship_$tax_type$_proletariat
		}

		save_scope_as = taxed_governorship
		owner = {
			change_variable = {
				name = INCOME_national_from_$tax_type$
				add = scope:taxed_governorship.INCOME_governorship_$tax_type$_total_positive
			}
		}
	}
	
}

INCOME_cache_governorship_income = {
	# Scope: Governorship
	# Function: Set the government income in a governorship into a variable.
	# The constituent svalues will be available in tooltips, but does not need to be cached.
	set_variable = {
		name = INCOME_governorship_total
		value = INCOME_governorship_total
	}
}

INCOME_cache_governorship_military_supplies_demand = {
	# Scope: Governorship
	# Function: Save to var the total military supplies demanded by this governorship so it can be re-referenced
	set_variable = {
		name = INCOME_military_supplies_demand_governorship
		value = INCOME_military_supplies_demand_governorship
	}
}

INCOME_cache_country_military_supplies_demand = {
	set_variable = {
		name = INCOME_military_supplies_demand_country
		value = {
			value = 0
			every_governorships = {
				add = var:INCOME_military_supplies_demand_governorship
			}
		}
	}
}

INCOME_get_wealth_owed_for_military_supplies_governorship = {
	# Scope: Governorship
	# Function: Get the amount of wealth owed for military supplies procurement
	set_variable = {
		name = INCOME_wealth_owed_for_military_supplies
		value = {
			value = var:INCOME_military_supplies_demand_governorship
			if = {
				limit = {
					owner = {
						has_variable = INCOME_military_supplies_demand_country
					}
					trigger_if = {
						limit = {
							owner = {
								has_variable = INCOME_military_supplies_demand_country
							}
						}
						owner.var:INCOME_military_supplies_demand_country > 0
					}
				}
				divide = owner.var:INCOME_military_supplies_demand_country
			}
			multiply = owner.var:INCOME_cost_military_supplies_country
			multiply = -1
		}
	}
}

INCOME_calculate_all_military_procurement_wealth_owed = {
	# Scope: Country
	# Function: Get the amount of wealth owed for military procurement for all governorships
	every_governorships = {
		INCOME_cache_governorship_military_supplies_demand = yes
	}
	INCOME_cache_country_military_supplies_demand = yes
	every_governorships = {
		INCOME_get_wealth_owed_for_military_supplies_governorship = yes
	}
}

INCOME_calculate_and_distribute_military_procurement_wealth_owed = {
	# Scope: Country
	INCOME_calculate_all_military_procurement_wealth_owed = yes
	every_governorships = {
		change_variable = {
			name = upper_strata_wealth
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_upper_strata
			}
		}
		change_variable = {
			name = middle_strata_wealth
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_middle_strata
			}
		}
		change_variable = {
			name = lower_strata_wealth
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_lower_strata
			}
		}
		change_variable = {
			name = proletariat_wealth
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_proletariat
			}
		}
		change_variable = {
			name = indentured_wealth
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_indentured
			}
		}
		change_variable = {
			name = slaves_wealth
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_slaves
			}
		}
		change_variable = {
			name = tribesmen_wealth
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_tribesmen
			}
		}
		##################
		change_variable = {
			name = this_income_from_manufacturing_upper_strata
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_upper_strata
			}
		}
		change_variable = {
			name = this_income_from_manufacturing_middle_strata
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_middle_strata
			}
		}
		change_variable = {
			name = this_income_from_manufacturing_lower_strata
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_lower_strata
			}
		}
		change_variable = {
			name = this_income_from_manufacturing_proletariat
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_proletariat
			}
		}
		change_variable = {
			name = this_income_from_manufacturing_indentured
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_indentured
			}
		}
		change_variable = {
			name = this_income_from_manufacturing_slaves
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_slaves
			}
		}
		change_variable = {
			name = this_income_from_manufacturing_tribesmen
			add = {
				value = var:INCOME_wealth_owed_for_military_supplies
				multiply = GT_trade_share_percentage_manufacturing_tribesmen
			}
		}
	}
}

INCOME_set_tax_modifier = {
	# Scope: Country
	# Function: Implement the modifier from setting a tax rate
	if = {
		limit = {
			has_variable = INCOME_taxrate_$category$
		}
		set_local_variable = {
			name = INCOME_taxrate_$category$_previous
			value = var:INCOME_taxrate_$category$
		}
	}
	
	set_variable = {
        name = INCOME_taxrate_$category$
        value = $amount$
    }

	remove_country_modifier = INCOME_$category$_00_modifier
	remove_country_modifier = INCOME_$category$_03_modifier
	remove_country_modifier = INCOME_$category$_06_modifier
	remove_country_modifier = INCOME_$category$_09_modifier
	remove_country_modifier = INCOME_$category$_12_modifier
	remove_country_modifier = INCOME_$category$_075_modifier
	remove_country_modifier = INCOME_$category$_15_modifier
	remove_country_modifier = INCOME_$category$_225_modifier
	remove_country_modifier = INCOME_$category$_30_modifier


	add_country_modifier = {
		name = INCOME_$category$_$amount_aka$_modifier
		duration = -1
	}

	if = {
		limit = {
			has_local_variable = INCOME_taxrate_$category$_previous
		}
		set_local_variable = {
			name = INCOME_taxrate_diff
			value = {
				value = local_var:INCOME_taxrate_$category$_previous
				subtract = var:INCOME_taxrate_$category$
			}
		}
		remove_country_modifier = INCOME_recent_tax_increase
		remove_country_modifier = INCOME_recent_tax_decrease
		if = {
			limit = {
				local_var:INCOME_taxrate_diff < 0
			}
			add_country_modifier = {
				name = INCOME_recent_tax_increase
				duration = 365
			}
			
		}
		else_if = {
			limit = {
				local_var:INCOME_taxrate_diff > 0
			}
			add_country_modifier = {
				name = INCOME_recent_tax_decrease
				duration = 365
			}
			
		}
		remove_local_variable = INCOME_taxrate_$category$_previous
	}

	
}

INCOME_mitigate_deficit = {
	# Scope: Country
	# Function: Sell off reserves or take out debt to get to positive treasury if the country is in deficit
	# Triggered only if auto_fund_deficit is on

	if = {
		limit = {
			treasury < 0 # TODO: Check is now handled by on_action, consider removing
		}

		set_variable = {
			name = negative_treasury
			value = treasury
		}

		# Issue national debt
		if = {
			limit = {
				has_variable = public_debt_administration
			}
			set_local_variable = {
				name = debt_needed_for_deficit_millions
				value = {
					value = treasury
					divide = {
						value = CURRENCY_debt_wealth_value_10k_units
						multiply = 100
					}
					multiply = -1
				}
			}
			set_variable = {
				name = PI_needed_for_deficit
				value = {
					value = CURRENCY_debt_issue_political_influence_cost_1m
					multiply = local_var:debt_needed_for_deficit_millions
				}
			}
			add_political_influence = var:PI_needed_for_deficit
			CURRENCY_alter_own_debt = {
				thousands = 0
				millions = local_var:debt_needed_for_deficit_millions
				billions = 0
			}
			add_treasury = {
				value = treasury
				multiply = -1
			}
		}

		# Sell off metal reserves
		else_if = {
			limit = {
				OR = {
					var:gold_reserve_size > 0
					var:silver_reserve_size > 0
				}
			}

			# If the currency has a dependency on one particular reserve metal
			if = {
				limit = {
					has_variable = official_currency
					trigger_if = {
						limit = {
							has_variable = official_currency
						}
						var:official_currency = {
							OR = {
								NOT = {
									var:backing_type = flag:bimetallic_standard
								}
								AND = {
									var:backing_type = flag:gold_standard
									var:silver_reserve_size > 0
								}
								AND = {
									var:backing_type = flag:silver_standard
									var:gold_reserve_size > 0
								}
							}
						}
					}
				}
				# Sell silver first if the currency relies on gold
				if = {
					limit = {
						var:official_currency.var:backing_type = flag:gold_standard
						var:silver_reserve_size > 0
					}
					# Calculate the needed amount of gold
					set_local_variable = {
						name = silver_needed_for_deficit
						value = {
							value = treasury # Amount of deficit
							divide = global_var:global_base_import_price_silver
							multiply = -1
						}
					}
					INCOME_sell_reserves = {
						metal = silver
						amount = local_var:silver_needed_for_deficit
					}
				}
				# Sell gold first if the currency relies on silver
				else_if = {
					limit = {
						var:official_currency.var:backing_type = flag:silver_standard
						var:gold_reserve_size > 0
					}
					set_local_variable = {
						name = gold_needed_for_deficit
						value = {
							value = treasury # Amount of deficit
							divide = global_var:global_base_import_price_gold
							multiply = -1
						}
					}
					INCOME_sell_reserves = {
						metal = gold
						amount = local_var:gold_needed_for_deficit
					}
				}
				else = {
					INCOME_sell_largest_reserve = yes
				}
			}
			# Otherwise sell whichever you have the most of in terms of wealth value
			else = {
				INCOME_sell_largest_reserve = yes
			}
		}

	}
}

INCOME_sell_largest_reserve = {
	set_local_variable = {
		name = gold_reserve_value_greater_than_silver
		value = {
			value = var:gold_reserve_size
			multiply = global_var:global_base_import_price_gold
			subtract = {
				value = var:silver_reserve_size
				multiply = global_var:global_base_import_price_silver
			}
		}
	}
	if = {
		limit = {
			local_var:gold_reserve_value_greater_than_silver > 0
		}
		set_local_variable = {
			name = gold_needed_for_deficit
			value = {
				value = treasury # Amount of deficit
				divide = global_var:global_base_import_price_gold
				multiply = -1
			}
		}
		INCOME_sell_reserves = {
			metal = gold
			amount = local_var:gold_needed_for_deficit
		}
	}
	else = {
		set_local_variable = {
			name = silver_needed_for_deficit
			value = {
				value = treasury # Amount of deficit
				divide = global_var:global_base_import_price_silver
				multiply = -1
			}
		}
		INCOME_sell_reserves = {
			metal = silver
			amount = local_var:silver_needed_for_deficit
		}
	}
}

INCOME_sell_reserves = {
	# Scope: Country
	# Function: Sell precious metal reserves and send the income to the treausry
	set_local_variable = {
		name = amount_to_sell
		value = $amount$
	}
	if = {
		limit = {
			var:$metal$_reserve_size < $amount$
		}
		set_local_variable = {
			name = amount_to_sell
			value = var:$metal$_reserve_size
		}
	}
	change_variable = {
        name = $metal$_reserve_size
        subtract = local_var:amount_to_sell
    }
    set_local_variable = {
    	name = treasury_income_from_reserve_sale
    	value = {
    		value = global_var:global_base_import_price_$metal$
    		multiply = local_var:amount_to_sell
    	}
    }
    add_treasury = local_var:treasury_income_from_reserve_sale
    capital_scope.governorship = {
        change_variable = {
            name = $metal$_stockpile
            add = local_var:amount_to_sell
        }
    }
}