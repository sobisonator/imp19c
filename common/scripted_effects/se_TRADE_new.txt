TRADE_cache_svalues_governorship_food_prices = {
	# Scope: governorship
	# Function: Save svalues as variables so that they do not have to be re-calculated every time they are called
	# This focuses on saving calculation-heavy svalues that are referenced more than once, reducing the overall number of calculations
	set_variable = {
		name = var_governorship_population
		value = governorship_population
	}
	set_variable = {
		name = var_DEMAND_unfulfilled_food_need_governorship
		value = DEMAND_unfulfilled_food_need_governorship
	}
}

TRADE_cache_svalues_governorship_food_avg_price = {
	# Scope: governorship
	# Function: save the average price of food goods in a governorship
	set_variable = {
		name = var_DEMAND_food_avg_price
		value = DEMAND_food_avg_price
	}
	set_variable = {
		name = var_DEMAND_food_avg_price_normalised
		value = DEMAND_food_avg_price_normalised
	}
}

TRADE_add_to_country_total_demand_difference = {
	# Scope: every governorship in a country
	# Function: add to a variable in the internal trade scope, and the internal trade scope of the capital of all trade partners
	var:internal_trade_scope = {
		change_variable = {
			name = trade_scope_total_demand_difference
			add = prev.DEMAND_difference_$tradegood$
		}
	}
	owner = {
		every_in_list = {
			variable = list_of_trade_partners_all_categories
			capital_scope.governorship = {
				var:internal_trade_scope = {
					change_variable = {
						name = trade_scope_total_demand_difference
						add = prev.prev.DEMAND_difference_$tradegood$
					}
				}
			}
		}
	}
}

TRADE_refresh_country_total_demand_differences = {
	# Scope: every country
	# Function: set the trade_scope_total_demand_difference variable to exist and set it at 0
	set_variable = {
		name = trade_scope_total_demand_difference
		value = 0 
	}
}

TRADE_refresh_federation_CU_total_demand_differences = {
	# Scope: random country
	# Function: set the trade_scope_total_demand_difference variable to exist and set it at 0
	every_federation = {
		set_variable = {
			name = trade_scope_total_demand_difference
			value = 0 
		}
	}
}

TRADE_country_update_all_total_demand_differences = {
	# Scope: random country
	# Function: run TRADE_add_to_country_total_demand_difference in every country
	TRADE_refresh_country_total_demand_differences = yes
	every_tradegood_complex = { # TODO: Break this down into categories for which trade deals can be struck (e.g. food, industrial, military...)
		APPLY = TRADE_add_to_country_total_demand_difference
	}
}

# NOT IN USE
TRADE_update_food_prices_TZs = {
	# Scope: random country
	# Called: quarterly
	# Function: update the prices for all foods
	TRADE_update_price_supply_demand_TZs = {
		tradegood = grain
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = livestock
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = fish
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = vegetables
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = tropical_fruit
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = mediterranean_fruit
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = temperate_fruit
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = processed_foods
	}
	every_country = {
		every_governorships = {
			TRADE_set_price_governorship = {
				tradegood = grain
			}
			TRADE_set_price_governorship = {
				tradegood = livestock
			}
			TRADE_set_price_governorship = {
				tradegood = fish
			}
			TRADE_set_price_governorship = {
				tradegood = vegetables
			}
			TRADE_set_price_governorship = {
				tradegood = tropical_fruit
			}
			TRADE_set_price_governorship = {
				tradegood = mediterranean_fruit
			}
			TRADE_set_price_governorship = {
				tradegood = temperate_fruit
			}
			TRADE_set_price_governorship = {
				tradegood = processed_foods
			}
		}
		every_governorships = {
			TRADE_update_price_TZs = {
				tradegood = grain
			}
			TRADE_update_price_TZs = {
				tradegood = livestock
			}
			TRADE_update_price_TZs = {
				tradegood = fish
			}
			TRADE_update_price_TZs = {
				tradegood = vegetables
			}
			TRADE_update_price_TZs = {
				tradegood = tropical_fruit
			}
			TRADE_update_price_TZs = {
				tradegood = mediterranean_fruit
			}
			TRADE_update_price_TZs = {
				tradegood = temperate_fruit
			}
			TRADE_update_price_TZs = {
				tradegood = processed_foods
			}
		}
		every_governorships = {
			TRADE_set_price_governorship = {
				tradegood = grain
			}
			TRADE_set_price_governorship = {
				tradegood = livestock
			}
			TRADE_set_price_governorship = {
				tradegood = fish
			}
			TRADE_set_price_governorship = {
				tradegood = vegetables
			}
			TRADE_set_price_governorship = {
				tradegood = tropical_fruit
			}
			TRADE_set_price_governorship = {
				tradegood = mediterranean_fruit
			}
			TRADE_set_price_governorship = {
				tradegood = temperate_fruit
			}
			TRADE_set_price_governorship = {
				tradegood = processed_foods
			}
		}
	}
}

TRADE_first_time_setup_price_TZs_food = {
	# Scope: random country
	# Called: at start of game
	# Function: Set up the first time prices and set a flag so that demand based on historical prices is not dividing by zero

	TRADE_update_price_supply_demand_TZs = {
		tradegood = grain
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = livestock
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = fish
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = vegetables
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = tropical_fruit
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = mediterranean_fruit
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = temperate_fruit
	}
	TRADE_update_price_supply_demand_TZs = {
		tradegood = processed_foods
	}
	every_country = {
		every_governorships = {
			TRADE_set_price_governorship = {
				tradegood = grain
			}
			TRADE_set_price_governorship = {
				tradegood = livestock
			}
			TRADE_set_price_governorship = {
				tradegood = fish
			}
			TRADE_set_price_governorship = {
				tradegood = vegetables
			}
			TRADE_set_price_governorship = {
				tradegood = tropical_fruit
			}
			TRADE_set_price_governorship = {
				tradegood = mediterranean_fruit
			}
			TRADE_set_price_governorship = {
				tradegood = temperate_fruit
			}
			TRADE_set_price_governorship = {
				tradegood = processed_foods
			}
			TRADE_cache_svalues_governorship_food_avg_price = yes
			TRADE_update_price_TZs = {
				tradegood = grain
			}
			TRADE_update_price_TZs = {
				tradegood = livestock
			}
			TRADE_update_price_TZs = {
				tradegood = fish
			}
			TRADE_update_price_TZs = {
				tradegood = vegetables
			}
			TRADE_update_price_TZs = {
				tradegood = tropical_fruit
			}
			TRADE_update_price_TZs = {
				tradegood = mediterranean_fruit
			}
			TRADE_update_price_TZs = {
				tradegood = temperate_fruit
			}
			TRADE_update_price_TZs = {
				tradegood = processed_foods
			}
		}
	}
}

TRADE_first_time_setup_simulation_run = {
	TRADE_first_time_setup_price_TZs_food = yes
	set_global_variable = first_time_price_setup_food_done
	TRADE_first_time_setup_price_TZs_food = yes
	TRADE_first_time_setup_price_TZs_food = yes
	TRADE_first_time_setup_price_TZs_food = yes
}

TRADE_update_price_supply_demand_TZs = {
	# Scope:random country
	# Function: set the base price for the given tradegood in every tradezone
	# Reset the total supply and demand in the tradezone to 0
	every_trade_center = {
		if = {
			limit = { has_global_variable = first_time_price_setup_food_done }
			set_variable = {
				name = price_$tradegood$
				value = var:TZ_demand_$tradegood$
			}
			change_variable = {
				name = price_$tradegood$
				divide = var:TZ_supply_$tradegood$
			}
		}
		else = {
			set_variable = {
				name = price_$tradegood$
				value = 1
			}
		}

		# Then zero the demand and supply so it can be updated for next quarter
		set_variable = {
			name = TZ_demand_$tradegood$
			value = 1
		}
		set_variable = {
			name = TZ_supply_$tradegood$
			value = 1
		}
	}
}

TRADE_update_price_TZs = {
	# Scope: iterating every governorship
	# Function: update the price of tradegoods in the TZ
	set_variable = {
		name = var_DEMAND_food_avg_price
		value = DEMAND_food_avg_price
	}
	var:trade_center = {
		if = {
			limit = {
				has_global_variable = first_time_price_setup_food_done
			}
			change_variable = {
				name = TZ_demand_$tradegood$
				add = prev.DEMAND_actual_$tradegood$
			}
		}
		else = {
			change_variable = {
				name = TZ_demand_$tradegood$
				add = prev.DEMAND_$tradegood$
			}
		}
		if = {
			limit = {
				prev.DEMAND_difference_$tradegood$ > 0
			}
			change_variable = {
				name = TZ_supply_$tradegood$
				add = prev.DEMAND_difference_$tradegood$
			}
		}
	}
}

TRADE_set_price_governorship = {
	# Scope: governorship
	# Function: Set the price for the given tradegood
	# Price will be based on the TZ price, modified locally based on the country's trade partners
	# Save demand this quarter into a variable for last quarter
	# Price will go down if demand dropped compared to the last check
	set_variable = {
		name = price_$tradegood$
		value = var:trade_center.var:price_$tradegood$
	}
}