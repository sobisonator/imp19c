namespace = diplomatic_play

diplomatic_play.1 = {
    # Scope: Country

    # Based on the Fashoda incident
    # Part 1: Offer the instigator the option to proceed
    # Present 3 characters with high martial to lead the expedition

	# Trigger weights:
	# High play balance of power

    type = country_event
    title = diplomatic_play.1.t
    desc = diplomatic_play.1.desc

    left_portrait = scope:foreign_minister

    picture = naval_bay

    goto_location = scope:diplomatic_play.var:play_target_area

    trigger = {
        scope:diplomatic_play.var:play_target_country = {
            NOT = { tag = BAR }
            exists = yes
        }
    }

    option = { # Support
        name = diplomatic_play.1.a
        custom_tooltip = diplomatic_play.1.a.tt
        ai_chance = {
            modifier = {
                factor = 10
                opinion = {
                    target = scope:diplomatic_play.var:play_target_country
                    value < 0
                }
            }
            modifier = {
                factor = 20
                opinion = {
                    target = scope:diplomatic_play.var:play_target_country
                    value < -99
                }
            }
            modifier = {
                factor = 10
                scope:foreign_minister = {
                    martial > charisma
                }
            }
            modifier = {
                factor = 10
                scope:diplomatic_play.var:play_instigator.ruler = {
                    martial > charisma
                }
            }
        }
        POLITICS_upset_pacifists = {
            level = minor
        }
        add_treasury = {
            value = var:country_unit_price_early_munitions # TODO: Factor in balance of early/late munitions
            add = var:country_unit_price_construction_materials
            multiply = -10
        }

    }

    option = { # Super support
        name = diplomatic_play.1.b 
        custom_tooltip = diplomatic_play.1.b.tt
        highlight = yes
        ai_chance = {
            modifier = {
                factor = 5
                opinion = {
                    target = scope:diplomatic_play.var:play_target_country
                    value > 0
                }
            }
            modifier = {
                factor = 10
                opinion = {
                    target = scope:diplomatic_play.var:play_target_country
                    value > 99
                }
            }
            modifier = {
                factor = 5
                scope:foreign_minister = {
                    martial > charisma
                }
            }
            modifier = {
                factor = 5
                scope:diplomatic_play.var:play_instigator.ruler = {
                    martial > charisma
                }
            }
        }
        
        trigger = {
            var:MILITARY_supplies_country > 0
        }

        POLITICS_upset_pacifists = {
            level = major
        }

        change_variable = {
            name = MILITARY_supplies_country
            subtract = 10
        }
        add_treasury = {
            value = var:country_unit_price_early_munitions # TODO: Factor in balance of early/late munitions
            add = var:country_unit_price_construction_materials
            multiply = -20
        }
        
        add_political_influence = -5
        add_aggressive_expansion = 5

        scope:diplomatic_play = {
            # TODO: Add delay (no delay for testing purposes)
            every_in_list = {
                variable = play_observers_undecided
                add_to_list = all_observers
            }
            every_in_list = {
                variable = play_observers_support_instigator
                add_to_list = all_observers
            }
            every_in_list = {
                variable = play_observers_support_target
                add_to_list = all_observers
            }

            random_in_list = {
                list = all_observers
                limit = {
                    NOT = { THIS = scope:diplomatic_play.var:play_instigator }
                }
                save_scope_as = catcher
            }
            debug_log = catcher
            DIPLOMACY_trigger_play_event = {
                pov = scope:catcher
                id = diplomatic_play.3 # Catcher snags the expedition en-route
                days = 0 # TODO: 21
            }

        }
        
    }

    option = { # Deny
        name = diplomatic_play.1.c 
        custom_tooltip = diplomatic_play.1.c.tt
        ai_chance = {
            modifier = {
                factor = 10
                opinion = {
                    target = scope:diplomatic_play.var:play_target_country
                    value > 0
                }
            }
            modifier = {
                factor = 20
                opinion = {
                    target = scope:diplomatic_play.var:play_target_country
                    value > 99
                }
            }
            modifier = {
                factor = 10
                scope:foreign_minister = {
                    charisma > martial
                }
            }
            modifier = {
                factor = 10
                scope:diplomatic_play.var:play_instigator.ruler = {
                    charisma > martial
                }
            }
        }
        add_political_influence = -5
        POLITICS_upset_militarists = {
            level = minor
        }          

    }
}

diplomatic_play.2 = {
    # Scope: Country, target of the play

    # Major expedition arrives
    # Follow-up from diplomatic_play.1

    type = country_event
    title = diplomatic_play.2.t
    desc = diplomatic_play.2.desc

    left_portrait = scope:foreign_minister

    picture = naval_bay

    goto_location = scope:diplomatic_play.var:play_target_area

    immediate = {
        DIPLOMACY_notify_player = {
            event = AI_notification_event.1
        }
        ordered_owned_province = {
            limit = {
                area = scope:diplomatic_play.var:play_target_area.area
                any_neighbor_province = {
                    OR = {
                        owner = scope:play_instigator
                        owner.overlord = {
                            exists = yes
                            THIS = scope:play_instigator
                        }
                        is_sea = yes
                    }
                }
                is_capital = no
            }
            order_by = {
                value = total_population
                multiply = -1
                add = SHIPPING_province_power
            }
            save_scope_as = captured_province
        }
        scope:diplomatic_play = {
            DIPLOMACY_progress_play = {
                success = 1
                progress = DIPLOMACY_play_progress_large
            }
        }

    }

    option = { # Nothing we can do
        name = diplomatic_play.2.a
        custom_tooltip = diplomatic_play.2.a.tt
        ai_chance = {
            modifier = {
                factor = 10
                scope:diplomatic_play.var:AI_play_power_balance_instigator_root > 10
            }
        }

        scope:diplomatic_play.var:play_instigator = {
            set_variable = {
                name = diplomatic_play_captured_province
                value = scope:captured_province
            }
        }

        add_stability = -10
        add_war_exhaustion = 1
        scope:captured_province = {
            LAND_transfer_province = {
                grantee = scope:play_instigator
            }
        }
        add_opinion = {
            modifier = bitter_over_occupation
            target = scope:play_instigator
        }
        # Notify player of the annexation
        DIPLOMACY_notify_player = {
            event = AI_notification_event.3
        }
        # Notify the aggressor of their success
        scope:diplomatic_play = {
            DIPLOMACY_trigger_play_event = {
                pov = scope:play_instigator
                id = diplomatic_play.6 # Expedition succeeded in annexation
                days = 0
            }
        }
        scope:diplomatic_play = {
            DIPLOMACY_progress_play = {
                success = 25
                progress = DIPLOMACY_play_progress_large
            }
        }
    }

    option = { # Send a garrison, prevent them from entering any further
        # (They will still gain a stake in the area)
        name = diplomatic_play.2.b
        custom_tooltip = diplomatic_play.2.b.tt
        ai_chance = {
            factor = 20
        }

        add_war_exhaustion = 1
        add_manpower = -2
        add_opinion = {
            modifier = diplomatic_play_escalated
            target = scope:play_instigator
        }
        scope:captured_province = {
            DIPLOMACY_add_colonial_outpost = {
                owner = scope:play_instigator
            }
        }
        scope:diplomatic_play = {
            DIPLOMACY_progress_play = {
                success = 1
                progress = DIPLOMACY_play_progress_medium
            }
        }

    }

    option = { # Prepare an immediate attack
        name = diplomatic_play.2.c
        custom_tooltip = diplomatic_play.2.c.tt
        ai_chance = {
            modifier = {
                factor = 5
            }
            modifier = {
                factor = -5
                scope:diplomatic_play.var:AI_play_power_balance_instigator_root > 10
            }
            modifier = {
                factor = -5
                scope:diplomatic_play.var:AI_play_power_balance_instigator_root > 1
            }
        }

        add_aggressive_expansion = 1
        add_war_exhaustion = 1
        add_manpower = -4
        add_opinion = {
            modifier = diplomatic_play_escalated
            target = scope:play_instigator
        }
        scope:diplomatic_play = {
            DIPLOMACY_trigger_play_event = {
                pov = scope:play_instigator
                id = diplomatic_play.4 # Expedition attacked
                days = 0
            }
        }
        scope:diplomatic_play = {
            DIPLOMACY_progress_play = {
                success = -10
                progress = DIPLOMACY_play_progress_large
            }
        }
    }

}

diplomatic_play.3 = {
    # Scope: Country, random play observer

    # Expedition caught on the way to target
    # Follow-up from diplomatic_play.1

    type = country_event
    title = diplomatic_play.3.t
    desc = diplomatic_play.3.desc

    left_portrait = scope:foreign_minister

    picture = naval_bay

    goto_location = scope:diplomatic_play.var:play_target_area

    immediate = {
        save_scope_as = catcher
    }

    option = { # Stop the expedition
        name = diplomatic_play.3.a
        custom_tooltip = diplomatic_play.3.a.tt

        ai_chance = {

            modifier = {
                factor = 10
            }
            modifier = {
                factor = 10 # Higher chance of a vassal not defending an incursion into its overlord
                is_subject = yes
                overlord = scope:diplomatic_play.var:play_target_country
            }
            modifier = {
                factor = 100
                alliance_with = scope:diplomatic_play.var:play_target_country
            }
            modifier = {
                factor = 10
                opinion = {
                    target = scope:diplomatic_play.var:play_target_country
                    value > 0
                }
            }
            modifier = {
                factor = -10
                scope:diplomatic_play = {
                    is_target_in_variable_list = {
                        name = play_observers_support_instigator
                        target = scope:catcher
                    }
                }
            }
        }

        scope:diplomatic_play = {

            DIPLOMACY_progress_play = {
                success = -10
                progress = DIPLOMACY_play_progress_large
            }

            var:play_instigator = {
                set_variable = {
                    name = play_expedition_catcher
                    value = scope:catcher
                }
            }

            DIPLOMACY_trigger_play_event = {
                pov = scope:diplomatic_play.var:play_instigator
                id = diplomatic_play.7 # Expedition is stopped by 3rd party
                days = 0
            }
        }


        add_opinion = {
            modifier = betrayed_in_play
            target = scope:diplomatic_play.var:play_instigator
        }

        add_opinion = {
            modifier = helped_in_play
            target = scope:diplomatic_play.var:play_target_country
        }

        DIPLOMACY_notify_player = {
            event = AI_notification_event.2
        }

    }

    option = { # Allow the expedition to continue
        name = diplomatic_play.3.b
        custom_tooltip = diplomatic_play.3.b.tt
        ai_chance = {
            modifier = {
                factor = 1
            }
            modifier = {
                factor = 10
                opinion = {
                    target = scope:diplomatic_play.var:play_target_instigator
                    value > 100
                }
            }
            modifier = {
                factor = 10
                alliance_with = scope:diplomatic_play.var:play_target_instigator
            }
            modifier = {
                factor = 100
                is_subject = yes
                overlord = scope:diplomatic_play.var:play_instigator
            }
            modifier = { # Don't care enough
                factor = 5
                scope:diplomatic_play = {
                    is_target_in_variable_list = {
                        name = play_observers_undecided
                        target = scope:catcher
                    }
                }
            }
            modifier = {
                factor = -100
                scope:diplomatic_play = {
                    is_target_in_variable_list = {
                        name = play_observers_support_target
                        target = scope:catcher
                    }
                }
            }
        }

        add_opinion = {
            modifier = helped_in_play
            target = scope:diplomatic_play.var:play_instigator
        }

        add_opinion = {
            modifier = betrayed_in_play
            target = scope:diplomatic_play.var:play_target_country
        }

        scope:diplomatic_play = {
            DIPLOMACY_trigger_play_event = {
                pov = scope:catcher
                id = diplomatic_play.2 # Expedition arrives
                days = 0 # TODO: 7
            }
        }

    }

}

diplomatic_play.4 = {
    # Scope: Country, Play instigator

    # Expedition attacked by the target

    type = country_event
    title = diplomatic_play.4.t
    desc = diplomatic_play.4.desc

    left_portrait = scope:foreign_minister

    picture = naval_bay

    goto_location = scope:diplomatic_play.var:play_target_area

    immediate = {
        save_scope_as = catcher
    }

    option = { # Back down
        name = diplomatic_play.4.a
        custom_tooltip = diplomatic_play.4.a.tt

        ai_chance = {
            modifier = {
                factor = 20
            }
            modifier = {
                factor = 50
                scope:diplomatic_play.var:AI_play_power_balance_instigator_root < 1
            }
        }

        add_stability = -2
        scope:diplomatic_play = {
            DIPLOMACY_progress_play = {
                success = -25
                progress = DIPLOMACY_play_progress_large
            }
        }

    }

    option = { # Declare war
        name = diplomatic_play.4.b
        custom_tooltip = diplomatic_play.4.b.tt
        ai_chance = {
            modifier = {
                factor = 1
            }
            modifier = {
                factor = 5
                scope:diplomatic_play.var:AI_play_power_balance_instigator_root > 10
            }
            modifier = {
                factor = 5
                scope:diplomatic_play.var:AI_play_power_balance_instigator_root > 1
            }
            modifier = {
                factor = 5
                opinion = {
                    target = scope:diplomatic_play.var:play_target_country
                    value < -100
                }
            }
            modifier = {
                factor = 5
                scope:foreign_minister = {
                    martial > charisma
                }
            }
            modifier = {
                factor = 5
                scope:diplomatic_play.var:play_instigator.ruler = {
                    martial > charisma
                }
            }
        }

        scope:diplomatic_play.var:play_instigator = {

            add_political_influence = -5
            add_aggressive_expansion = 5

            # TODO: Use a scripted effect to declare a diplomatic play war, adding all the supporters for both sides.
            scope:diplomatic_play = { 
                DIPLOMACY_trigger_diplomatic_play_war = yes
            }
        }
        scope:diplomatic_play = {
            AI_remove_diplomatic_play = yes
        }

    }

}

diplomatic_play.5 = {
    # Scope: Country, Play instigator

    # Expedition limited success, establishes outpost

    type = country_event
    title = diplomatic_play.5.t
    desc = diplomatic_play.5.desc

    left_portrait = scope:foreign_minister

    picture = naval_bay

    goto_location = scope:diplomatic_play.var:play_target_area

    option = { # Yay!
        name = diplomatic_play.5.a

        ai_chance = {
            modifier = {
                factor = 10
            }
        }

    }

}

diplomatic_play.6 = {
    # Scope: Country, Play instigator

    # Expedition major success, annexes a territory

    type = country_event
    title = diplomatic_play.6.t
    desc = diplomatic_play.6.desc

    left_portrait = scope:foreign_minister

    picture = naval_bay

    goto_location = scope:diplomatic_play.var:play_target_area

    option = { # Yay!
        name = diplomatic_play.6.a

        ai_chance = {
            modifier = {
                factor = 10
            }
        }

        remove_variable = diplomatic_play_captured_province

    }

}

diplomatic_play.7 = {
    # Scope: Country, Play instigator

    # Expedition stopped by a third party

    type = country_event
    title = diplomatic_play.7.t
    desc = diplomatic_play.7.desc

    left_portrait = scope:foreign_minister

    picture = naval_bay

    goto_location = scope:diplomatic_play.var:play_target_area

    immediate = {
        var:play_expedition_catcher = {
            save_scope_as = catcher
        }
    }

    option = { # Declare war!
        name = diplomatic_play.7.a
        custom_tooltip = diplomatic_play.7.a.tt

        ai_chance = {
            modifier = {
                factor = 1
            }
            modifier = { # more likely to declare war if it won't trigger a whole play war
                factor = 1
                scope:diplomatic_play = {
                    NOT = {
                        is_target_in_variable_list = {
                            name = play_observers_support_target
                            target = scope:catcher
                        }
                    }
                }
            }
            modifier = {
                factor = 1
                DIPLOMACY_power > scope:catcher.DIPLOMACY_power
            }
            
        }

        # Scenario 1: The catcher is a neutral party
        # Just declare war on the catcher
        FUNC_declare_war_with_wargoal_province = {
            war_goal = conquer_wargoal
            province = scope:catcher.capital_scope
            target = scope:catcher
        }

        # Scenario 2: The catcher is a member of the opposing side
        # Trigger a full diplomatic play war
        scope:diplomatic_play = {
            DIPLOMACY_trigger_diplomatic_play_war = yes
        }

        remove_variable = play_expedition_catcher

    }

    option = { # Back down
        name = diplomatic_play.7.a
        custom_tooltip = diplomatic_play.7.b.tt

        ai_chance = {
            modifier = {
                factor = 10
            }
            modifier = {
                factor = 10
                DIPLOMACY_power < scope:catcher.DIPLOMACY_power
            }
            modifier = {
                factor = 10000

                opinion = {
                    target = scope:catcher
                    value > 0
                }
            }
            modifier = { # Being stopped by an ally will not trigger war
                factor = 10000

                OR = {
                    # Is supporter
                    scope:diplomatic_play = {
                        is_target_in_variable_list = {
                            name = play_observers_support_instigator
                            target = scope:catcher
                        }
                    }
                    # Is ally
                    any_allied_country = scope:catcher
                }
                
            }
            
        }

        add_stability = -2
        scope:diplomatic_play = {
            DIPLOMACY_progress_play = {
                success = -25
                progress = DIPLOMACY_play_progress_large
            }
        }

        remove_variable = play_expedition_catcher

    }

}